language: python
python:
  - "3.13"

services:
  - docker

env:
  global:
    - DOCKER_IMAGE_NAME=iris-ml-api

before_install:
  # Update Docker to latest version
  - docker --version

install:
  # Install Python dependencies
  - pip install -r requirements.txt

before_script:
  # Train the model before running tests
  - cd src && python train_model.py && cd ..

script:
  # Run unit tests
  - pytest tests/ -v --tb=short
  
  # Build Docker image
  - docker build -t $DOCKER_IMAGE_NAME:$TRAVIS_BUILD_NUMBER .
  - docker build -t $DOCKER_IMAGE_NAME:latest .
  
  # Test Docker container
  - docker run -d -p 8000:8000 --name test_container $DOCKER_IMAGE_NAME:latest
  - sleep 10  # Wait for container to start
  - curl -f http://localhost:8000/ || exit 1
  - curl -f http://localhost:8000/health || exit 1
  - docker stop test_container
  - docker rm test_container

after_success:
  # Optional: Push to Docker Hub (uncomment and add Docker Hub credentials in Travis CI settings)
  # Add DOCKERHUB_USERNAME and DOCKERHUB_TOKEN (Personal Access Token) as environment variables in Travis CI
  # - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  # - docker push $DOCKER_IMAGE_NAME:$TRAVIS_BUILD_NUMBER
  # - docker push $DOCKER_IMAGE_NAME:latest
  - echo "Build successful!"

after_failure:
  - echo "Build failed!"
  - docker logs test_container || true

notifications:
  email:
    on_success: change
    on_failure: always

cache:
  pip: true
  directories:
    - $HOME/.cache/pip
